---
title: "IOH and dengue updates"
author: "Alyson Singleton"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
# install packages, load libraries, set themes, knit formatting
pacman::p_load(tidyverse, dplyr, kableExtra, knitr, sf, raster, terra, spData, tmap, leaflet, ggplot2, spThin, mapdata, rnaturalearth, rnaturalearthdata, brazilmaps, devtools, brazilmaps, mapview, grid, gridExtra, RColorBrewer, raster, plm, fixest)
theme_set(theme_bw())
knitr::opts_chunk$set(echo = F, results='asis', warning=F, message=F, cache=T,
                      fig.height=5, fig.width=10)

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

library(showtext)
font_add("Arial", "/Library/Fonts/Arial.ttf")  # Use the actual file path
showtext_auto()
```

# Summary

This analysis will investigate the effect of road building and paving on dengue and leishmaniasis—diseases transmitted by mosquitoes and sandfly vectors, respectively—in Peru’s Amazon basin. Building off of two months of field work in Summer 2022 that spurred a collaboration with Universidad Peruana Cayetano Heredia (UPCH) and the Regional Health Directorate of Madre de Dios (DIRESA, in Spanish), I plan to analyze how road quality upgrades drive changes in mobility through recently deforested areas, facilitating disease diffusion. A rapid paving of the Interoceanic Highway (2007-2009) throughout the region provides a unique opportunity to compare disease case data from health centers within 5km of the newly paved highway and those outside a 5km buffer before and after the highway was paved (a difference-in-differences causal inference approach). This work will include image classification analysis to create historical road development and quality datasets from satellite-imagery. I hypothesize that we will see dengue incidence increase almost immediately post paving (dengue produces highly localized outbreaks and responds directly to human movement), while leishmaniasis will not increase immediately post-paving and will act as a placebo (leishmaniasis transmission is affected more by frontier clearings and development of agricultural land).

# Background 

#### Treatment cutoffs

A map of all spatial units in our region of interest ($n=70$), colored by treatment group options. All results in this document use a 5km cutoff, which results in 26 units in the treatment group and 44 in the control group. Tentatively, the results have not been sensitive to cutoff choice.

```{r}
center_lat_long <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mapping_cutoffs.csv")
cluster_ids <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/building_spatial_units/cluster_centroids_70.csv")
center_lat_long <- left_join(center_lat_long, cluster_ids, by='clust')
center_lat_long <- center_lat_long %>%
  group_by(clust) %>%
  summarize(onekm=max(onekm),
            fivekm=max(fivekm),
            tenkm=max(tenkm),
            longitude=max(longitude.y),
            latitude=max(latitude.y))
## health center locations figure
#center_lat_long <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/e_salud_key_with_lat_long.csv")
center_lat_long <- data.frame(center_lat_long)
center_lat_long <- center_lat_long %>%
  mutate(latitude= as.numeric(latitude),longitude= as.numeric(longitude),
         cluster=clust) %>%
  sf::st_as_sf(coords = c('longitude','latitude'), crs = st_crs(4326))
#center_lat_long <- st_transform(center_lat_long$geometry, 4326)
#mapview(center_lat_long, xcol = "longitude", ycol = "latitude", crs = 4269, grid = FALSE)

center_lat_long$fivekm <- ifelse(center_lat_long$fivekm>0, 2, 0)
center_lat_long$tenkm <- ifelse(center_lat_long$tenkm>0, 3, 0)
for(i in 1:dim(center_lat_long)[1]){
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$onekm[i]>0, 1, 0)
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$fivekm[i]>1&&center_lat_long$onekm[i]==0, 2, center_lat_long$all_cutoffs[i])
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$tenkm[i]>2&&center_lat_long$fivekm[i]==0&&center_lat_long$onekm[i]==0, 3, center_lat_long$all_cutoffs[i])
  #center_lat_long$all_cutoffs[i] <- min(center_lat_long$onekm[i],center_lat_long$fivekm[i],center_lat_long$tenkm[i])
}

districts <- read_sf("~/Desktop/doctorate/ch2 mdd highway/peru_shapefiles/Madre_de_Dios.shp")
districts <- st_as_sf(districts) 
districts$geometry <- st_transform(districts$geometry, 4326)

highway <- read_sf("~/Desktop/doctorate/ch2 mdd highway/peru_shapefiles/peru_roads_important.shp")
highway <- highway[which(highway$ref=="PE-30C"),]
highway <- st_as_sf(highway) 
highway$geometry <- st_transform(highway$geometry, 4326)

mdd_region <- st_union(districts$geometry)
highway_mdd <- st_covers(mdd_region,highway$geometry, sparse = FALSE)
highway_mdd <- highway[highway_mdd[1,],]

no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank(),
                 panel.grid.major = element_blank())

# Plot all Brazilian states
center_lat_long$all_cutoffs <- as.character(center_lat_long$all_cutoffs)
center_lat_long$clust <- as.character(center_lat_long$clust)
fig1a <- ggplot() +
  geom_sf(data=districts, fill='#ffffff', color='#626262', size=.15, show.legend = FALSE) +
  geom_sf(data = highway_mdd, aes(geometry = geometry), colour='black', linewidth=1) +
  geom_sf(data = center_lat_long, aes(geometry = geometry, fill=all_cutoffs, line='grey'), pch=21, size = 2.7, alpha=1) + #colour='#25CED1',
  scale_fill_manual(name= "Cutoff", values=c("0" = "#fffffc", "1" = "#ffcccc", "2" = "#41b6c4", "3" = "#225ea8"),
                    labels=c("Control", "1km", "5km", "10km")) +
  theme_minimal() +
  no_axis +
  theme(legend.text=element_text(size=14),
        legend.title=element_text(size=16),
        legend.position='right') +
  
  guides(fill=guide_legend(override.aes=list(shape=21)))
fig1a
legend <- get_legend(fig1a)

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure1.pdf", fig1a, width = 8, height = 8, units = c("in"), device="pdf")
```

#### Dengue coverage

Bar plot showing how many spatial units had at least one case of dengue for each year in our data. Blue is "far" (control) and yellow is "near" (treatment).

```{r}
## data coverage calculation
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data.csv")
incidence_data_yearly$case_yn <- ifelse(incidence_data_yearly$yearly_cases>0, 1, 0)
dengue_coverage_yearly <- incidence_data_yearly %>%
  group_by(year, fivekm) %>%
  summarize(coverage = sum(case_yn))

#plot coverage
dengue_coverage_yearly$fivekm <- as.character(dengue_coverage_yearly$fivekm)
dengue_coverage_yearly <- dengue_coverage_yearly[0:42,]
dengue_coverage_yearly$year <- format(as.Date(dengue_coverage_yearly$year, format="%Y-%m-%d"),"%Y")
dengue_yearly_coverage_plot <- ggplot(dengue_coverage_yearly) +
  geom_col(aes(x= year, y=coverage, fill=fivekm), width=0.5, color="white", position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  geom_vline(aes(xintercept=("2008")), linetype='dashed', size=0.4) +
  xlab("Year") + ylab("No. spatial units\nw dengue case\n(n=70)") + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        #axis.title=element_text(size=20),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=10, angle=45, vjust=0.45),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
dengue_yearly_coverage_plot
```

#### Leishmaniasis coverage

Bar plot showing how many spatial units had at least one case of leishmaniasis for each year in our data. Blue is "far" (control) and yellow is "near" (treatment).

```{r}
## data coverage calculation
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_leish_incidence_data.csv")
incidence_data_yearly$case_yn <- ifelse(incidence_data_yearly$yearly_cases>0, 1, 0)
leish_coverage_yearly <- incidence_data_yearly %>%
  group_by(year, fivekm) %>%
  summarize(coverage = sum(case_yn))

#plot coverage
leish_coverage_yearly$fivekm <- as.character(leish_coverage_yearly$fivekm)
leish_coverage_yearly <- leish_coverage_yearly[0:42,]
leish_coverage_yearly$year <- format(as.Date(leish_coverage_yearly$year, format="%Y-%m-%d"),"%Y")
leish_yearly_coverage_plot <- ggplot(leish_coverage_yearly) +
  geom_col(aes(x= year, y=coverage, fill=fivekm), color="white", width=0.5, position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  geom_vline(aes(xintercept=("2008")), linetype='dashed', size=0.4) +
  xlab("Year") + ylab("No. spatial units\nw leish case\n(n=70)") + 
  theme_bw() +
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        #axis.title=element_text(size=20),
        axis.title.y=element_text(size=14, angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=10, angle=45, vjust=0.45),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
leish_yearly_coverage_plot
```

# Dengue results

## Yearly dengue incidence and population calculation

Raw data showing yearly dengue incidence in treatment (<5km) and control (>5km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

Yearly population data was calculated by combining remotely-sensed WorldPop population data (2000-2020) and health center surveillance data from DIRESA (2009-2017). All years with DIRESA data were kept, and all years without DIRESA data were filled in with adjusted WorldPop data. WorldPop data was adjusted by the average ratio between DIRESA and WorldPop data for each spatial unit for years where we had both DIRESA and WorldPop data. This adjusted population data is used for all of the following results.  

```{r}
#incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data.csv")
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data_pop_adjusted.csv")
incidence_data$year <- as.Date(incidence_data$year)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

vert_line_date <- as.Date('2008-01-01')
#plots
#onekm
onekm_plotting <- incidence_data %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

onekm_yearly <- ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#onekm_yearly

#fivekm
fivekm_plotting <- incidence_data %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

fivekm_yearly <- ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
fivekm_yearly

#tenkm
tenkm_plotting <- incidence_data %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

tenkm_yearly <- ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_yearly
``` 

```{r, eval=F}
#### Removing Puerto Maldonado spatial unit, varying near/far cut point (1km, 5km, 10km). Vertical line at 2008.
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data.csv")
incidence_data$year <- as.Date(incidence_data$year)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

#plots
#onekm
onekm_plotting <- incidence_data_nopm %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data_nopm %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data_nopm %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

## Diff-in-diff results (yearly dengue model)

Each dot in this plot represents the beta coefficient for each year in the regression model, and the error bars display a 95% confidence interval. Each coefficient estimates the difference in yearly incidence between near and far healthcare centers for each year. If the hypothesis that the highway paving increased dengue transmission is correct, we should see the coefficients diverge from zero and become positive following 2008 (last year before hypothesized "shock"). Indeed, we see the coefficients diverge from zero starting in 2009 and generally increase over time. Additionally, all coefficients prior to 2009 are zero, which supports the parallel trends assumption. This model includes unit and year fixed effects, and standard errors are clustered at the unit and yearly levels (accounting for spatial and temporal autocorrelation). 

UPDATE (Jan 22nd): These results now include controls for yearly mean precipitation, yearly mean temperature, and yearly urban area, with no noticeable impact (as expected).

```{r, adjusted pop}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_yearly_covariates.csv")
covariates$year <- as.character(covariates$year)
covariates$year <- lubridate::ymd(covariates$year, truncated = 2L)
covariates$year <- format(as.Date(covariates$year,"%Y"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("cluster"="cluster", "year" = "year"))
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly_no_pm)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

#mean
sum(coef(summary(test))[9:20])
sum(coef(summary(test))[9:19])

pop <- incidence_data_yearly %>%
  group_by(year,fivekm) %>%
  summarise(pop_sum = sum(population))
mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
pop_1 <- pop[which(pop$fivekm==1),]
pop_1 <- pop_1[10:21,]

#using mean pop
sum(coef(summary(test))[9:20])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
sum(coef(summary(test))[9:20]+test$coeftable[9:20,2])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
sum(coef(summary(test))[9:20]-test$coeftable[9:20,2])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)

#yearly pop instead of mean pop
coef(summary(test))[9:20]*pop_1[,3]
sum(coef(summary(test))[9:20]*pop_1[,3])
sum((coef(summary(test))[9:20]+test$coeftable[9:20,2])*pop_1[,3])
sum((coef(summary(test))[9:20]-test$coeftable[9:20,2])*pop_1[,3])

#percent idea
sum(coef(summary(test))[9:20]*pop_1[,3])/pop_1[12,3]

df <- as.data.frame(test$coeftable)
df <- df[1:20,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_yearly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("Difference in\nyearly dengue\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.165))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure2.pdf", dengue_yearly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")

```

```{r, worldpop dengue yearly, eval=F}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') | cluster + year, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_yearly_did <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("Yearly\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.31))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did
```

## Biannual dengue model

Raw data showing biannual dengue incidence in treatment (<5km) and control (>5km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

```{r}
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/biannual_incidence_data_pop_adjusted.csv")
incidence_data$biannual_date <- as.Date(incidence_data$biannual_date)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

#plots
#onekm
onekm_plotting <- incidence_data %>%
  group_by(onekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

onekm_quarterly <- ggplot(onekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#onekm_quarterly

#fivekm
fivekm_plotting <- incidence_data %>%
  group_by(fivekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

fivekm_quarterly <- ggplot(fivekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
fivekm_quarterly

#tenkm
tenkm_plotting <- incidence_data %>%
  group_by(tenkm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

tenkm_quarterly <- ggplot(tenkm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_quarterly

``` 

All the same as the description for the yearly model above, except for unit and biannual fixed effects and standard errors are clustered at the unit and biannual levels. I also colored the coefficients by rainy (red) or dry (white) season. The rainy season is regarded as the main dengue season in this region and runs from the beginning of October to the end of March. 

UPDATE (Jan 22nd): These results now include controls for biannual mean precipitation, biannual mean temperature, and biannual urban area, with no noticeable impact (as expected).

```{r}
### biannual model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/biannual_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$biannual_cases/incidence_data_yearly$population
incidence_data_yearly$biannual_date <- as.factor(incidence_data_yearly$biannual_date)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_biannual_covariates.csv")
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("cluster"="cluster", "biannual_date" = "biannual_date"))

test <- feols(incidence ~ i(biannual_date, fivekm, ref = '2008-04-01') + mean_precip + mean_temp + urban_area | cluster + biannual_date, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
df <- df[1:41,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$biannual_date <- as.Date(c(unique(incidence_data_yearly$biannual_date)[c(1:16,18:42)]))
df$rainy <- 0
df$rainy[c(seq(1, 41, 2))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_quarterly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=biannual_date, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-04-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-04-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(biannual_date, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', 'red'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("Difference in\nbiannual dengue\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.12))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_quarterly_did_popadj
ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure3.pdf", dengue_quarterly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")
```

```{r, worldpop dengue quarterly, eval=F}
### quarterly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/quarterly_incidence_data.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$quarterly_cases/incidence_data_yearly$population
incidence_data_yearly$quarter <- as.factor(incidence_data_yearly$quarter)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(quarter, fivekm, ref = '2008-12-31') | cluster + quarter, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$quarter <- c(seq(as.Date("2000-03-01"), as.Date("2008-09-01"), by="quarter"),
                seq(as.Date("2009-03-01"), as.Date("2020-12-01"), by="quarter"))
df$rainy <- 0
df$rainy[c(seq(4, 83, 4))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_quarterly_did <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=quarter, ymax=upper, ymin=lower), color='black', width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-12-31")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-12-31"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(quarter, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', 'red'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("Quarterly\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.175))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_quarterly_did
```

```{r, eval=F}
### quarterly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/quarterly_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$quarterly_cases/incidence_data_yearly$population
incidence_data_yearly$quarter <- as.factor(incidence_data_yearly$quarter)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(quarter, fivekm, ref = '2008-12-31') | cluster + quarter, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$quarter <- c(seq(as.Date("2000-03-01"), as.Date("2008-09-01"), by="quarter"),
                seq(as.Date("2009-03-01"), as.Date("2020-12-01"), by="quarter"))
df$rainy <- 0
df$rainy[c(seq(4, 83, 4))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_quarterly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=quarter, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-12-31")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-12-31"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(quarter, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', 'red'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("Quarterly\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.10))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_quarterly_did_popadj
```

```{r, eval=F}
#### Removing Puerto Maldonado spatial unit, varying near/far cut point (1km, 5km, 10km). Vertical line at 2008.

incidence_data_nopm <- incidence_data_quarterly[!(incidence_data_quarterly$cluster %in% 1),]

#plots
#onekm
onekm_plotting <- incidence_data_quarterly %>%
  group_by(onekm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data_quarterly %>%
  group_by(fivekm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data_quarterly %>%
  group_by(tenkm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

```{r, Monthly incidence, eval=F}
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/monthly_incidence_data.csv")
incidence_data$month <- as.Date(incidence_data$month)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

incidence_data_quarterly <- incidence_data %>% 
  group_by(quarter = lubridate::quarter(month, type = "date_last"), cluster)
incidence_data_quarterly <- incidence_data_quarterly  %>%
  group_by(quarter,cluster) %>%
  summarize(quarterly_cases = sum(monthly_cases),
            onekm=max(onekm),
            fivekm=max(fivekm),
            tenkm=max(tenkm),
            population=mean(population)) 
  
#plots
#onekm
onekm_plotting <- incidence_data %>%
  group_by(onekm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data %>%
  group_by(fivekm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data %>%
  group_by(tenkm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

```{r, Monthly incidence no PM, eval=F}
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

#plots
#onekm
onekm_plotting <- incidence_data_nopm %>%
  group_by(onekm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data_nopm %>%
  group_by(fivekm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data_nopm %>%
  group_by(tenkm, month) %>%
  summarize(new_incidence = sum(monthly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=month, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Monthly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

# Leish results

## Yearly leish incidence

Raw data showing yearly leishmaniasis incidence in treatment (<5km) and control (>5km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

```{r}
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_leish_incidence_data_pop_adjusted.csv")
incidence_data$year <- as.Date(incidence_data$year)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

vert_line_date <- as.Date('2008-01-01')
#plots
#onekm
onekm_plotting <- incidence_data %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

onekm_yearly_leish <- ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#onekm_yearly_leish

#fivekm
fivekm_plotting <- incidence_data %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

fivekm_yearly_leish <- ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
fivekm_yearly_leish

#tenkm
tenkm_plotting <- incidence_data %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

tenkm_yearly_leish <- ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_yearly_leish
``` 

## Diff-in-diff results (yearly leish model)

All the same as the description for the yearly dengue model above, except that now we would expect the coefficients to center on zero both before and after the paving. This would align with our hypothesis that leishmaniasis transmission was not impacted by the road paving. The coefficients are as expected. Please see the end of this document for easy side-by-side comparisons of the two disease systems. 

UPDATE (Jan 22nd): These results now include controls for yearly mean precipitation, yearly mean temperature, and yearly urban area, with no noticeable impact (as expected).

```{r}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_leish_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_yearly_covariates.csv")
covariates$year <- as.Date(as.character(covariates$year),"%Y")
covariates$year <- format(as.Date(covariates$year,"%Y-01-22"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("cluster"="cluster", "year" = "year"))

test <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') + mean_precip + mean_temp + urban_area | cluster + year, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
df <- df[1:20,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_yearly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("Difference in\nyearly leish\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.16))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_yearly_did_popadj
ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure2leish.pdf", leish_yearly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")

```

```{r, worldpop leish yearly, eval=F}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_leish_incidence_data.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') | cluster + year, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_yearly_did <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("Yearly\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.31))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_yearly_did
```

```{r, eval=F}
#### Removing Puerto Maldonado spatial unit, varying near/far cut point (1km, 5km, 10km). Vertical line at 2008.

incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_leish_incidence_data.csv")
incidence_data$year <- as.Date(incidence_data$year)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]

#plots
#onekm
onekm_plotting <- incidence_data_nopm %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data_nopm %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data_nopm %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

## Biannual leish model

Raw data showing quarterly leishmaniasis incidence in treatment (<5km) and control (>5km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

UPDATE (Jan 22nd): These results now include controls for biannual mean precipitation, biannual mean temperature, and biannual urban area, with no noticeable impact (as expected).

```{r}
incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/biannual_leish_incidence_data_pop_adjusted.csv")
incidence_data$biannual_date <- as.Date(incidence_data$biannual_date)
incidence_data$onekm <- as.character(incidence_data$onekm)
incidence_data$fivekm <- as.character(incidence_data$fivekm)
incidence_data$tenkm <- as.character(incidence_data$tenkm)
incidence_data_nopm <- incidence_data[!(incidence_data$cluster %in% 1),]
  
#plots
#onekm
onekm_plotting <- incidence_data %>%
  group_by(onekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

onekm_quarterly_leish <- ggplot(onekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#onekm_quarterly_leish

#fivekm
fivekm_plotting <- incidence_data %>%
  group_by(fivekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

fivekm_quarterly_leish <- ggplot(fivekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
fivekm_quarterly_leish

#tenkm
tenkm_plotting <- incidence_data %>%
  group_by(tenkm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

tenkm_quarterly_leish <- ggplot(tenkm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_quarterly_leish
``` 

```{r, worldpop leish quarterly, eval=F}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/quarterly_leish_incidence_data.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$quarterly_cases/incidence_data_yearly$population
incidence_data_yearly$quarter <- as.factor(incidence_data_yearly$quarter)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

test <- feols(incidence ~ i(quarter, fivekm, ref = '2008-12-31') | cluster + quarter, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$quarter <- c(seq(as.Date("2000-03-01"), as.Date("2008-09-01"), by="quarter"),
                seq(as.Date("2009-03-01"), as.Date("2020-12-01"), by="quarter"))
df$rainy <- 0
df$rainy[c(seq(4, 83, 4))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_quarterly_did <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=quarter, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-12-31")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-12-31"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(quarter, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', 'red'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("Quarterly\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.175))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_quarterly_did
```

All the same as the description for the quarterly dengue model above, except that we expect coefficients to remain at zero as we did for the yearly leish regression model. Season coloring is the same as the biannual dengue model above.

```{r}
### biannual model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/biannual_leish_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$biannual_cases/incidence_data_yearly$population
incidence_data_yearly$biannual_date <- as.factor(incidence_data_yearly$biannual_date)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_biannual_covariates.csv")
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("cluster"="cluster", "biannual_date" = "biannual_date"))

test <- feols(incidence ~ i(biannual_date, fivekm, ref = '2008-04-01') + mean_precip + mean_temp + urban_area | cluster + biannual_date, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- as.data.frame(test$coeftable)
df <- df[1:41,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$biannual_date <- as.Date(c(unique(incidence_data_yearly$biannual_date)[c(1:16,18:42)]))
df$rainy <- 0
df$rainy[c(seq(1, 41, 2))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_quarterly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=biannual_date, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-04-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-04-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(biannual_date, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', 'red'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("Difference in\nbiannual leish\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.12))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_quarterly_did_popadj
ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure3leish.pdf", leish_quarterly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")

```

```{r, eval=F}
#### Removing Puerto Maldonado spatial unit, varying near/far cut point (1km, 5km, 10km). Vertical line at 2008.

#plots
#onekm
onekm_plotting <- incidence_data_nopm %>%
  group_by(onekm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(onekm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>1km (far)', '<1km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#fivekm
fivekm_plotting <- incidence_data_nopm %>%
  group_by(fivekm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(fivekm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>5km (far)', '<5km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

#tenkm
tenkm_plotting <- incidence_data_nopm %>%
  group_by(tenkm, quarter) %>%
  summarize(new_incidence = sum(quarterly_cases)/sum(population))

ggplot(tenkm_plotting) +
  geom_line(aes(x=quarter, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Quarterly\nincidence") + 
  scale_color_manual(values=c('#3ecbdd', '#FFBC42'), labels=c('>10km (far)', '<10km (near)')) + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))

``` 

## Side by side plots to compare the disease systems

```{r}
#dengue_yearly_did + ggtitle("Dengue yearly (worldpop)")
#leish_yearly_did + ggtitle("Leish yearly (worldpop)")

dengue_yearly_did_popadj + ggtitle("Dengue yearly")
leish_yearly_did_popadj + ggtitle("Leish yearly")

#dengue_quarterly_did + ggtitle("Dengue quarterly (worldpop)")
#leish_quarterly_did + ggtitle("Leish quarterly (worldpop)")

dengue_quarterly_did_popadj + ggtitle("Dengue biannually")
leish_quarterly_did_popadj + ggtitle("Leish biannually")
```

# Sensitivity Analyses

## Spatial boundary sensitivity analysis
```{r, spatial bounday sensitivity}
test5km <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly)
test1km <- feols(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly)
test10km <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, vcov = "cluster", data = incidence_data_yearly)
#test <- feols(incidence ~ i(year, tenkm, ref = '2008-01-01') | cluster + year, data = incidence_data_yearly)
#summary(test)
#class(test)

df <- rbind(
  as.data.frame(cbind(test5km$coeftable[1:20,],c(rep("5km",20)))),
  as.data.frame(cbind(test1km$coeftable[1:20,],c(rep("1km",20)))),
  as.data.frame(cbind(test10km$coeftable[1:20,],c(rep("10km",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Cutoff')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Cutoff <- factor(as.character(df$Cutoff), levels=c('1km','5km','10km'))
dengue_yearly_did_popadj_spatial_sens <- ggplot(df, aes(group=Cutoff)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Cutoff), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Cutoff), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('1km'="#DC267F",'5km'="#FFB000",'10km'='#648FFF'))+
  scale_fill_manual(values=list('1km'="#DC267F",'5km'="#FFB000",'10km'='#648FFF'))+
  xlab("Year") + ylab("Difference in\nyearly dengue\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_spatial_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure4v2.pdf", dengue_yearly_did_popadj_spatial_sens, width = 12, height = 6, units = c("in"), device="pdf")

```

## Pueto Maldonado sensitivity analysis
```{r, pm sensitivity}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_yearly_covariates.csv")
covariates$year <- as.character(covariates$year)
covariates$year <- lubridate::ymd(covariates$year, truncated = 2L)
covariates$year <- format(as.Date(covariates$year,"%Y"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("cluster"="cluster", "year" = "year"))
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]

#build models
test_wpm <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly)
test_wopm <- feols(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = incidence_data_yearly_no_pm)

df <- rbind(
  as.data.frame(cbind(test_wpm$coeftable[1:20,],c(rep("Yes PM",20)))),
  as.data.frame(cbind(test_wopm$coeftable[1:20,],c(rep("No PM",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Inclusion')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Inclusion <- factor(as.character(df$Inclusion), levels=c('Yes PM','No PM'))
dengue_yearly_did_popadj_pm_sens <- ggplot(df, aes(group=Inclusion)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Inclusion), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Inclusion), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  scale_fill_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  xlab("Year") + ylab("Difference in\nyearly dengue\nincidence") + 
  theme_bw()+
  ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_pm_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure5.pdf", dengue_yearly_did_popadj_pm_sens, width = 10, height = 6, units = c("in"), device="pdf")

```