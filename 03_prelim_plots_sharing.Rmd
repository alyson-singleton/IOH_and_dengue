---
title: "IOH and dengue updates"
author: "Alyson Singleton"
date: "`r Sys.Date()`"
output:
  html_document: default
  word_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
# install packages, load libraries, set themes, knit formatting
pacman::p_load(tidyverse, dplyr, kableExtra, knitr, sf, raster, terra, spData, tmap, leaflet, ggplot2, spThin, mapdata, rnaturalearth, rnaturalearthdata, brazilmaps, devtools, brazilmaps, mapview, grid, gridExtra, RColorBrewer, raster, plm, fixest, cobalt)
theme_set(theme_bw())
knitr::opts_chunk$set(echo = F, results='asis', warning=F, message=F, cache=F,
                      fig.height=5, fig.width=10)

get_legend<-function(myggplot){
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

library(showtext)
font_add("Arial", "/Library/Fonts/Arial.ttf")  # Use the actual file path
showtext_auto()

```
# Summary

This analysis will investigate the effect of road building and paving on dengue and leishmaniasis—diseases transmitted by mosquitoes and sandfly vectors, respectively—in Peru’s Amazon basin. Building off of two months of field work in Summer 2022 that spurred a collaboration with Universidad Peruana Cayetano Heredia (UPCH) and the Regional Health Directorate of Madre de Dios (DIRESA, in Spanish), I plan to analyze how road quality upgrades drive changes in mobility through recently deforested areas, facilitating disease diffusion. A rapid paving of the Interoceanic Highway (2007-2009) throughout the region provides a unique opportunity to compare disease case data from health centers within 5km of the newly paved highway and those outside a 5km buffer before and after the highway was paved (a difference-in-differences causal inference approach). This work will include image classification analysis to create historical road development and quality datasets from satellite-imagery. I hypothesize that we will see dengue incidence increase almost immediately post paving (dengue produces highly localized outbreaks and responds directly to human movement), while leishmaniasis will not increase immediately post-paving and will act as a placebo (leishmaniasis transmission is affected more by frontier clearings and development of agricultural land).

# Background 

#### Treatment cutoffs

A map of all spatial units in our region of interest ($n=70$), colored by treatment group options. All results in this document use a 5km cutoff, which results in 26 units in the treatment group and 44 in the control group. Tentatively, the results have not been sensitive to cutoff choice.

```{r}
center_lat_long <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mapping_cutoffs.csv")
cluster_ids <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/building_spatial_units/cluster_centroids_70.csv")
center_lat_long <- left_join(center_lat_long, cluster_ids, by='clust')
center_lat_long <- center_lat_long %>%
  group_by(clust) %>%
  summarize(onekm=max(onekm),
            fivekm=max(fivekm),
            tenkm=max(tenkm),
            longitude=max(longitude.y),
            latitude=max(latitude.y))
## health center locations figure
#center_lat_long <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/e_salud_key_with_lat_long.csv")
center_lat_long <- data.frame(center_lat_long)
center_lat_long <- center_lat_long %>%
  mutate(latitude= as.numeric(latitude),longitude= as.numeric(longitude),
         cluster=clust) %>%
  sf::st_as_sf(coords = c('longitude','latitude'), crs = st_crs(4326))
#center_lat_long <- st_transform(center_lat_long$geometry, 4326)
#mapview(center_lat_long, xcol = "longitude", ycol = "latitude", crs = 4269, grid = FALSE)

center_lat_long$fivekm <- ifelse(center_lat_long$fivekm>0, 2, 0)
center_lat_long$tenkm <- ifelse(center_lat_long$tenkm>0, 3, 0)
for(i in 1:dim(center_lat_long)[1]){
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$onekm[i]>0, 1, 0)
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$fivekm[i]>1&&center_lat_long$onekm[i]==0, 2, center_lat_long$all_cutoffs[i])
  center_lat_long$all_cutoffs[i] <- ifelse(center_lat_long$tenkm[i]>2&&center_lat_long$fivekm[i]==0&&center_lat_long$onekm[i]==0, 3, center_lat_long$all_cutoffs[i])
  #center_lat_long$all_cutoffs[i] <- min(center_lat_long$onekm[i],center_lat_long$fivekm[i],center_lat_long$tenkm[i])
}

districts <- read_sf("~/Desktop/doctorate/ch2 mdd highway/peru_shapefiles/Madre_de_Dios.shp")
districts <- st_as_sf(districts) 
districts$geometry <- st_transform(districts$geometry, 4326)

highway <- read_sf("~/Desktop/doctorate/ch2 mdd highway/peru_shapefiles/peru_roads_important.shp")
highway <- highway[which(highway$ref=="PE-30C"),]
highway <- st_as_sf(highway) 
highway$geometry <- st_transform(highway$geometry, 4326)

mdd_region <- st_union(districts$geometry)
highway_mdd <- st_covers(mdd_region,highway$geometry, sparse = FALSE)
highway_mdd <- highway[highway_mdd[1,],]

no_axis <- theme(axis.title=element_blank(),
                 axis.text=element_blank(),
                 axis.ticks=element_blank(),
                 panel.grid.major = element_blank())

# Plot MdD
center_lat_long$all_cutoffs <- as.character(center_lat_long$all_cutoffs)
center_lat_long$clust <- as.character(center_lat_long$clust)
fig1a <- ggplot() +
  geom_sf(data=districts, fill='#ffffff', color='#626262', size=.15, show.legend = FALSE) +
  geom_sf(data = highway_mdd, aes(geometry = geometry), colour='black', linewidth=1) +
  geom_sf(data = center_lat_long, aes(geometry = geometry, fill=all_cutoffs, line='grey'), pch=21, size = 2.7, alpha=1) + #colour='#25CED1',
  scale_fill_manual(name= "Cutoff", values=c("0" = "#fffffc", "1" = "#ffcccc", "2" = "#41b6c4", "3" = "#225ea8"),
                    labels=c("Control", "1km", "5km", "10km")) +
  theme_minimal() +
  no_axis +
  theme(legend.text=element_text(size=14),
        legend.title=element_text(size=16),
        legend.position='right') +
  
  guides(fill=guide_legend(override.aes=list(shape=21)))
fig1a
legend <- get_legend(fig1a)

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure1.pdf", fig1a, width = 8, height = 8, units = c("in"), device="pdf")
```

#### Compare observable characteristics between treatment and control
```{r, cobalt, eval=F}
### yearly model
incidence_data_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data_pop_adjusted.csv")
incidence_data_yearly$incidence <- incidence_data_yearly$yearly_cases/incidence_data_yearly$population
incidence_data_yearly$year <- as.factor(incidence_data_yearly$year)
incidence_data_yearly$onekm <- as.numeric(incidence_data_yearly$onekm)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/mdd_yearly_covariates.csv")
covariates$year <- as.character(covariates$year)
covariates$year <- lubridate::ymd(covariates$year, truncated = 2L)
covariates$year <- format(as.Date(covariates$year,"%Y"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
incidence_data_yearly <- full_join(incidence_data_yearly, covariates, by=c("twoway"="twoway", "year" = "year"))
incidence_data_yearly_no_pm <- incidence_data_yearly[!(incidence_data_yearly$cluster %in% 1),]
incidence_data_yearly <- incidence_data_yearly[complete.cases(incidence_data_yearly),]
incidence_data_yearly_no_pm <- incidence_data_yearly_no_pm[complete.cases(incidence_data_yearly_no_pm),]

incidence_data_yearly_pretreat <- incidence_data_yearly_no_pm[which(incidence_data_yearly_no_pm$year %in% as.character(seq(as.Date('2000-01-01'), as.Date('2008-01-01'), 'year'))),]
covariates <- c("mean_precip","mean_temp","urban_area", "population")
# Compute summary statistics for each covariate by treatment group
obs_balance <- cobalt::bal.tab(incidence_data_yearly_pretreat[, covariates], treat = incidence_data_yearly_pretreat$fivekm)
obs_balance

#but the Balance element is what we'll need for plotting
obs_balance <- obs_balance$Balance
obs_balance$var <- rownames(obs_balance)
obs_balance <- obs_balance %>% 
  dplyr::select(var, type = Type, smd = Diff.Un) %>%
  as_tibble() %>%
  mutate(data = "Unweighted")

ggplot(obs_balance, aes(x = smd, y = fct_reorder(var, smd))) +
  geom_point() +
  theme_minimal() + 
  geom_vline(xintercept = .10) +
  geom_vline(xintercept = -.10)
```

```{r, load yearly data}
vert_line_date <- as.Date('2008-01-01')

###################
### dengue data ###
###################

### yearly data
dengue_df_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/processed_case_data/yearly_incidence_data_pop_adjusted.csv")
dengue_df_yearly$incidence <- (dengue_df_yearly$yearly_cases+1)/dengue_df_yearly$population #add one so 0's dont go to infinity when logged
dengue_df_yearly$year <- as.factor(dengue_df_yearly$year)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/covariates_data/mdd_yearly_covariates.csv")
covariates$year <- as.character(covariates$year)
covariates$year <- lubridate::ymd(covariates$year, truncated = 2L)
covariates$year <- format(as.Date(covariates$year,"%Y"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
dengue_df_yearly <- full_join(dengue_df_yearly, covariates, by=c("cluster"="cluster", "year" = "year"))

#urban area + 0.001 (to be able to take the log later)
dengue_df_yearly$urban_area <- dengue_df_yearly$urban_area + 0.001

#remove 16 and 66 (pop zero)
dengue_df_yearly <- dengue_df_yearly[which(dengue_df_yearly$cluster %in% c(1:15, 17:65, 67:70)),]

#complete cases
dengue_df_yearly <- dengue_df_yearly[complete.cases(dengue_df_yearly),]

# remove extreme outliers
dengue_df_yearly <- dengue_df_yearly[which(dengue_df_yearly$incidence < 0.5),]
#write.csv(dengue_df_yearly, "~/Desktop/dengue_df_yearly.csv")

#check how many are always zero
dengue_df_yearly_zeroes <- dengue_df_yearly %>% 
  group_by(cluster) %>% 
  summarize(total_cases = sum(yearly_cases))
clusters_w_at_least_one_case <- dengue_df_yearly$cluster[which(dengue_df_yearly_zeroes$total_cases>0)]
dengue_df_yearly_at_least_one_case <- dengue_df_yearly[which(dengue_df_yearly$cluster %in% clusters_w_at_least_one_case),]
#write.csv(dengue_df_yearly_at_least_one_case, "~/Desktop/dengue_df_yearly_at_least_one_case.csv")

#remove PM
dengue_df_yearly_no_pm <- dengue_df_yearly[!(dengue_df_yearly$cluster %in% 1),]
dengue_df_yearly_no_pm <- dengue_df_yearly_no_pm[complete.cases(dengue_df_yearly_no_pm),]
#write.csv(dengue_df_yearly_no_pm, "~/Desktop/dengue_df_yearly_no_pm.csv")


#hist((log(incidence_data_yearly$incidence)*-1))
#summary(test)
#hist(unique(incidence_data_yearly$population))
#summary(unique(incidence_data_yearly$population))
#plot(predict(test, incidence_data_yearly)[!is.na(predict(test, incidence_data_yearly))], residuals(test))
#plot(predict(test_popweight, incidence_data_yearly), residuals(test_popweight))

###################
### leish data ####
###################
### yearly data
leish_df_yearly <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/processed_case_data/yearly_leish_incidence_data_pop_adjusted.csv")
leish_df_yearly$incidence <- (leish_df_yearly$yearly_cases+1)/leish_df_yearly$population #add one so 0's dont go to infinity when logged
leish_df_yearly$year <- as.factor(leish_df_yearly$year)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/covariates_data/mdd_yearly_covariates.csv")
covariates$year <- as.character(covariates$year)
covariates$year <- lubridate::ymd(covariates$year, truncated = 2L)
covariates$year <- format(as.Date(covariates$year,"%Y"), "%Y-01-01")
covariates$year <- as.character(covariates$year)
leish_df_yearly <- full_join(leish_df_yearly, covariates, by=c("cluster"="cluster", "year" = "year"))

#urban area (to be able to take the log later)
leish_df_yearly$urban_area <- leish_df_yearly$urban_area + 0.0001

#remove 16 and 66 (pop zero)
leish_df_yearly <- leish_df_yearly[which(leish_df_yearly$cluster %in% c(1:15, 17:65, 67:70)),]

#complete cases
leish_df_yearly <- leish_df_yearly[complete.cases(leish_df_yearly),]

# remove extreme outliers
leish_df_yearly <- leish_df_yearly[which(leish_df_yearly$incidence < 0.5),]
#write.csv(leish_df_yearly, "~/Desktop/leish_df_yearly.csv")

#check how many are always zero
leish_df_yearly_zeroes <- leish_df_yearly  %>% 
  group_by(cluster) %>% 
  summarize(total_cases = sum(yearly_cases))
leish_clusters_w_at_least_one_case <- leish_df_yearly$cluster[which(leish_df_yearly_zeroes$total_cases>0)]
leish_df_yearly_at_least_one_case <- leish_df_yearly[which(leish_df_yearly$cluster %in% leish_clusters_w_at_least_one_case),]
#write.csv(leish_df_yearly_at_least_one_case, "~/Desktop/leish_df_yearly_at_least_one_case.csv")

#remove PM
leish_df_yearly_no_pm <- leish_df_yearly[!(leish_df_yearly$cluster %in% 1),]
leish_df_yearly_no_pm <- leish_df_yearly[complete.cases(leish_df_yearly_no_pm),]
#write.csv(leish_df_yearly_no_pm, "~/Desktop/leish_df_yearly_no_pm.csv")

```

```{r, eval=F}
dengue_df_yearly <- read.csv("~/Desktop/dengue_df_yearly.csv")
dengue_df_yearly_at_least_one_case <- read.csv("~/Desktop/dengue_df_yearly_at_least_one_case.csv")
dengue_df_yearly_no_pm <- read.csv("~/Desktop/dengue_df_yearly_no_pm.csv")
leish_df_yearly <- read.csv("~/Desktop/leish_df_yearly.csv")
leish_df_yearly_at_least_one_case <- read.csv("~/Desktop/leish_df_yearly_at_least_one_case.csv")
leish_df_yearly_no_pm <- read.csv("~/Desktop/leish_df_yearly_no_pm.csv")
```

#### Dengue coverage

Bar plot showing how many spatial units had at least one case of dengue for each year in our data. Blue is "far" (control) and yellow is "near" (treatment).

```{r}
## data coverage calculation
leish_df_yearly$case_yn <- ifelse(leish_df_yearly$yearly_cases>0, 1, 0)
dengue_coverage_yearly <- leish_df_yearly %>%
  group_by(year, onekm) %>%
  summarize(coverage = sum(case_yn))

#plot coverage
dengue_coverage_yearly$onekm <- as.character(dengue_coverage_yearly$onekm)
dengue_coverage_yearly <- dengue_coverage_yearly[0:42,]
dengue_coverage_yearly$year <- format(as.Date(dengue_coverage_yearly$year, format="%Y-%m-%d"),"%Y")
dengue_yearly_coverage_plot <- ggplot(dengue_coverage_yearly) +
  geom_col(aes(x= year, y=coverage, fill=onekm), width=0.5, color="white", position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  geom_vline(aes(xintercept=("2008")), linetype='dashed', size=0.4) +
  xlab("Year") + ylab("No. spatial units\nw dengue case\n(n=70)") + 
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        #axis.title=element_text(size=20),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=10, angle=45, vjust=0.45),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
dengue_yearly_coverage_plot

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S1.pdf", dengue_yearly_coverage_plot, width = 10, height = 6, units = c("in"), device="pdf")
```

#### Leishmaniasis coverage

Bar plot showing how many spatial units had at least one case of leishmaniasis for each year in our data. Blue is "far" (control) and yellow is "near" (treatment).

```{r}
## data coverage calculation
leish_df_yearly$case_yn <- ifelse(leish_df_yearly$yearly_cases>0, 1, 0)
leish_coverage_yearly <- leish_df_yearly %>%
  group_by(year, onekm) %>%
  summarize(coverage = sum(case_yn))

#plot coverage
leish_coverage_yearly$onekm <- as.character(leish_coverage_yearly$onekm)
leish_coverage_yearly <- leish_coverage_yearly[0:42,]
leish_coverage_yearly$year <- format(as.Date(leish_coverage_yearly$year, format="%Y-%m-%d"),"%Y")
leish_yearly_coverage_plot <- ggplot(leish_coverage_yearly) +
  geom_col(aes(x= year, y=coverage, fill=onekm), color="white", width=0.5, position = position_dodge(width = 0.5)) +
  scale_fill_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  geom_vline(aes(xintercept=("2008")), linetype='dashed', size=0.4) +
  xlab("Year") + ylab("No. spatial units\nw leish case\n(n=70)") + 
  theme_bw() +
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        #axis.title=element_text(size=20),
        axis.title.y=element_text(size=14, angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=14),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=10, angle=45, vjust=0.45),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
leish_yearly_coverage_plot

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S1_leish.pdf", leish_yearly_coverage_plot, width = 10, height = 6, units = c("in"), device="pdf")

```

# Model specification

In this analysis, I estimate the following regression equation (run as a Poisson regression with the *fixest* package):

$$ log(y_{i,t})=\sum\limits_{\substack{\tau\in\{2000,...,2020\},\\\tau\neq2008}} \beta_\tau (DIST)_i \times \mathbb{1}\{t=\tau\}+\gamma_i+\lambda_t+\mathbf{X_{i,t}\theta}+\epsilon_{i,t} $$
Our outcome of interest, $log(y_{i,t})$, is the logged dengue incidence in healthcare center $i$ for year $t$. Our treatment variable, $DIST$, is a dummy (binary) variable that equals one for centers near the highway and zero for centers off the highway. The $DIST$ dummy variable interacts with year dummy variables (one for each year of interest and zero otherwise). We omit the last year before the highway was paved (i.e., the last year before treatment) as the baseline year (2008). 

The coefficients, $\beta$'s, on the interaction term then recover the response in our outcome of interest following the road paving. Each coefficient estimates the difference between near and far healthcare centers for each year in our set of $\tau$’s. If our hypothesis that the highway paving increased dengue transmission in the area is correct, we should see the coefficients diverge from zero and become positive following 2008. I conduct the same analysis for leishmaniasis incidence, and we will expect its $\beta$'s to remain near zero following 2008. 

We include spatial unit (i.e., healthcare center) fixed effects, $\gamma_i$’s, to help account for any time-invariant healthcare center characteristics such as differences in their ability to diagnose dengue cases, nearby populations, and general baseline dengue burden at the community level. We also include year fixed effects, $\lambda_t$’s, to account for large-scale climate, political, and other changes that might impact dengue comparably across all health care centers over time. Finally, we include three observable controls, noted by the matrix $X_{it}$, to explicitly account for any variation due to changes in temperature, precipitation, or urban area. The $\theta$ vector recovers the covariate coefficients (and is written second because of matrix multiplication ordering). Any remaining unobserved variation is captured by the error term, $\epsilon_{it}$.
 

# Dengue results

## Yearly dengue incidence and population calculation

Raw data showing yearly dengue incidence in treatment (<1km) and control (>1km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

Yearly population data was calculated by combining remotely-sensed WorldPop population data (2000-2020) and health center surveillance data from DIRESA (2009-2017). All years with DIRESA data were kept, and all years without DIRESA data were filled in with adjusted WorldPop data. WorldPop data was adjusted by the average ratio between DIRESA and WorldPop data for each spatial unit for years where we had both DIRESA and WorldPop data. This adjusted population data is used for all of the following results.  

```{r}
#incidence_data <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/yearly_incidence_data.csv")
dengue_df_yearly$year <- as.Date(dengue_df_yearly$year)
dengue_df_yearly$onekm <- as.character(dengue_df_yearly$onekm)
dengue_df_yearly$fivekm <- as.character(dengue_df_yearly$fivekm)
dengue_df_yearly$tenkm <- as.character(dengue_df_yearly$tenkm)

vert_line_date <- as.Date('2008-01-01')

#onekm
onekm_plotting <- dengue_df_yearly %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = (sum(yearly_cases)/sum(population)))

onekm_yearly <- ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
onekm_yearly

#fivekm
fivekm_plotting <- dengue_df_yearly %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

fivekm_yearly <- ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#fivekm_yearly

#tenkm
tenkm_plotting <- dengue_df_yearly %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = log(sum(yearly_cases)/sum(population)))

tenkm_yearly <- ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_yearly

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S2.pdf", onekm_yearly, width = 10, height = 6, units = c("in"), device="pdf")

```

```{r, all cutoffs raw data fig, eval=F}
#all cutoffs
incidence_data_yearly_buffered_test <- incidence_data_yearly_buffered
#incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==1),14]<-as.character(2)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==3),14]<-as.character(2)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==6),14]<-as.character(0)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==5),14]<-as.character(4)
table(incidence_data_yearly_buffered_test$all_cutoffs)/12

incidence_data_yearly_buffered_plotting <- incidence_data_yearly_buffered_test %>%
  group_by(all_cutoffs, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

incidence_data_yearly_buffered_plotting$year <- as.Date(incidence_data_yearly_buffered_plotting$year)
incidence_data_yearly_buffered_plotting$new_incidence <- as.numeric(incidence_data_yearly_buffered_plotting$new_incidence)
incidence_data_yearly_buffered_plotting$all_cutoffs <- as.character(incidence_data_yearly_buffered_plotting$all_cutoffs)
incidence_data_yearly_buffered_plotting$all_cutoffs <- factor(incidence_data_yearly_buffered_plotting$all_cutoffs, levels=c('1', '2', '4', '0'))

all_cutoffs_yearly <- ggplot(incidence_data_yearly_buffered_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=all_cutoffs)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#DC267F', '#FFB000','#648FFF',"#785EF0"), labels=c('<1km', '[1km, 10km)', '[10km, 30km)', '>30km')) +
  #scale_color_manual(name="Distance",values=list('2'="#DC267F",'3'="#FFB000",'4'='#648FFF', '0'="#785EF0"))+
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
all_cutoffs_yearly

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S3.pdf", all_cutoffs_yearly, width = 10, height = 6, units = c("in"), device="pdf")

#all cutoffs
incidence_data_yearly_buffered_test <- incidence_data_yearly_buffered
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==1),14]<-as.character(2)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==3),14]<-as.character(4)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==5),14]<-as.character(6)
#incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==0),14]<-as.character(6)
#table(incidence_data_yearly_buffered_test$all_cutoffs)/12

incidence_data_yearly_buffered_plotting <- incidence_data_yearly_buffered_test %>%
  group_by(all_cutoffs, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

incidence_data_yearly_buffered_plotting$year <- as.Date(incidence_data_yearly_buffered_plotting$year)
incidence_data_yearly_buffered_plotting$new_incidence <- as.numeric(incidence_data_yearly_buffered_plotting$new_incidence)
incidence_data_yearly_buffered_plotting$all_cutoffs <- as.character(incidence_data_yearly_buffered_plotting$all_cutoffs)
incidence_data_yearly_buffered_plotting$all_cutoffs <- factor(incidence_data_yearly_buffered_plotting$all_cutoffs, levels=c('2','4', '6', '0'))
table(incidence_data_yearly_buffered_plotting$all_cutoffs)

all_cutoffs_yearly2 <- ggplot(incidence_data_yearly_buffered_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=all_cutoffs)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Distance", values=c('#DC267F', '#FFB000','#648FFF', '#785EF0'), labels=c('<5km', '(5km, 20km]', '(20km, 40km]', '>40km')) +
  #scale_color_manual(name="Distance",values=list('2'="#DC267F",'3'="#FFB000",'4'='#648FFF', '0'="#785EF0"))+
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
all_cutoffs_yearly2

#all cutoffs
incidence_data_yearly_buffered_test <- incidence_data_yearly_buffered
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==1),14]<-as.character(2)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==3),14]<-as.character(4)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==5),14]<-as.character(6)
incidence_data_yearly_buffered_test[which(incidence_data_yearly_buffered_test$all_cutoffs==0),14]<-as.character(6)
table(incidence_data_yearly_buffered_test$all_cutoffs)/12

incidence_data_yearly_buffered_plotting <- incidence_data_yearly_buffered_test %>%
  group_by(all_cutoffs, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

incidence_data_yearly_buffered_plotting$year <- as.Date(incidence_data_yearly_buffered_plotting$year)
incidence_data_yearly_buffered_plotting$new_incidence <- as.numeric(incidence_data_yearly_buffered_plotting$new_incidence)
incidence_data_yearly_buffered_plotting$all_cutoffs <- as.character(incidence_data_yearly_buffered_plotting$all_cutoffs)
incidence_data_yearly_buffered_plotting$all_cutoffs <- factor(incidence_data_yearly_buffered_plotting$all_cutoffs, levels=c('2','4', '6'))
table(incidence_data_yearly_buffered_plotting$all_cutoffs)

all_cutoffs_yearly3 <- ggplot(incidence_data_yearly_buffered_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=all_cutoffs)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Distance", values=c('#DC267F', '#FFB000','#648FFF'), labels=c('<5km', '(5km, 20km]', '>20km')) +
  #scale_color_manual(name="Distance",values=list('2'="#DC267F",'3'="#FFB000",'4'='#648FFF', '0'="#785EF0"))+
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
all_cutoffs_yearly3

``` 

## Diff-in-diff results (yearly dengue model)

Each dot in this plot represents the beta coefficient for each year in the regression model, and the error bars display a 95% confidence interval. Each coefficient estimates the difference in yearly incidence between near and far healthcare centers for each year. If the hypothesis that the highway paving increased dengue transmission is correct, we should see the coefficients diverge from zero and become positive following 2008 (last year before hypothesized "shock"). Indeed, we see the coefficients diverge from zero starting in 2009 and generally increase over time. Additionally, all coefficients prior to 2009 are zero, which supports the parallel trends assumption. This model includes unit and year fixed effects, and standard errors are clustered at the unit and yearly levels (accounting for spatial and temporal autocorrelation). All results now include controls for yearly mean precipitation, yearly mean temperature, and yearly urban area, with no noticeable impact (as expected).

```{r, main specification}
dengue_df_yearly$onekm <- as.numeric(dengue_df_yearly$onekm)
dengue_df_yearly$fivekm <- as.numeric(dengue_df_yearly$fivekm)
dengue_df_yearly$tenkm <- as.numeric(dengue_df_yearly$tenkm)

### yearly model
dengue_yearly_model <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
#summary(dengue_yearly_model)

df <- as.data.frame(dengue_yearly_model$coeftable)
df <- df[1:20,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_yearly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj

#predict(test, incidence_data_yearly)
#hist((log(incidence_data_yearly$incidence)*-1))
#summary(test)
#hist(unique(incidence_data_yearly$population))
#summary(unique(incidence_data_yearly$population))
#plot(predict(test, incidence_data_yearly)[!is.na(predict(test, incidence_data_yearly))], residuals(test))
#plot(predict(test_popweight, incidence_data_yearly), residuals(test_popweight))

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure2.pdf", dengue_yearly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")

```

```{r, magnitude of impact calculations, eval=F}
#mean
sum(coef(summary(dengue_yearly_model))[9:20])
sum(coef(summary(dengue_yearly_model))[9:19])

pop <- incidence_data_yearly %>%
  group_by(year,fivekm) %>%
  summarise(pop_sum = sum(population))
mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
pop_1 <- pop[which(pop$fivekm==1),]
pop_1 <- pop_1[10:21,]
pop_total <- pop %>%
  group_by(year) %>%
  summarise(pop_sum = sum(pop_sum))

incidence_data_yearly_cases <- incidence_data_yearly %>%
  group_by(year) %>%
  summarise(cases_sum = sum(yearly_cases))

#using mean pop
sum(coef(summary(dengue_yearly_model))[9:20])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
sum(coef(summary(dengue_yearly_model))[9:20]+dengue_yearly_model$coeftable[9:20,2])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)
sum(coef(summary(dengue_yearly_model))[9:20]-dengue_yearly_model$coeftable[9:20,2])*mean(pop$pop_sum[which(pop$fivekm==1)],na.rm=T)

#yearly pop instead of mean pop
coef(summary(dengue_yearly_model))[9:20]*pop_1[,3]
sum(coef(summary(dengue_yearly_model))[9:20]*pop_1[,3])
sum((coef(summary(dengue_yearly_model))[9:20]+dengue_yearly_model$coeftable[9:20,2])*pop_1[,3])
sum((coef(summary(dengue_yearly_model))[9:20]-dengue_yearly_model$coeftable[9:20,2])*pop_1[,3])

#percent of population
sum(coef(summary(dengue_yearly_model))[9:20]*pop_1[,3])/pop_total[21,2]
sum((coef(summary(dengue_yearly_model))[9:20]+dengue_yearly_model$coeftable[9:20,2])*pop_1[,3])/pop_total[21,2]
sum((coef(summary(dengue_yearly_model))[9:20]-dengue_yearly_model$coeftable[9:20,2])*pop_1[,3])/pop_total[21,2]

#percent of dengue cases
sum(coef(summary(dengue_yearly_model))[9:20]*pop_1[,3])/sum(incidence_data_yearly_cases[c(10:21),2])

#average yearly percent increase
```

## Biannual dengue model

Raw data showing biannual dengue incidence in treatment (<1km) and control (>1km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

```{r, load biannual data}
###################
### dengue data ###
###################

### biannual data
dengue_df_biannual <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/processed_case_data/biannual_incidence_data_pop_adjusted.csv")
dengue_df_biannual$incidence <- (dengue_df_biannual$biannual_cases+1)/dengue_df_biannual$population #add one so 0's dont go to infinity when logged
dengue_df_biannual$biannual_date <- as.factor(dengue_df_biannual$biannual_date)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/covariates_data/mdd_biannual_covariates.csv")
dengue_df_biannual <- full_join(dengue_df_biannual, covariates, by=c("cluster"="cluster", "biannual_date" = "biannual_date"))

#urban area (to be able to take the log later)
dengue_df_biannual$urban_area <- dengue_df_biannual$urban_area + 0.001

#remove 16 and 66 (pop zero)
dengue_df_biannual <- dengue_df_biannual[which(dengue_df_biannual$cluster %in% c(1:15, 17:65, 67:70)),]

#complete cases
dengue_df_biannual <- dengue_df_biannual[complete.cases(dengue_df_biannual),]

# remove extreme outliers
dengue_df_biannual <- dengue_df_biannual[which(dengue_df_biannual$incidence < 0.5),]

#check how many are always zero
dengue_df_biannual_zeroes <- dengue_df_biannual %>% 
  group_by(cluster) %>% 
  summarize(total_cases = sum(biannual_cases))
clusters_w_at_least_one_case_biannual <- dengue_df_biannual$cluster[which(dengue_df_biannual_zeroes$total_cases>0)]
dengue_df_biannual_at_least_one_case <- dengue_df_biannual[which(dengue_df_biannual$cluster %in% clusters_w_at_least_one_case_biannual),]

#remove PM
dengue_df_biannual_no_pm <- dengue_df_biannual[!(dengue_df_biannual$cluster %in% 1),]
dengue_df_biannual_no_pm <- dengue_df_biannual[complete.cases(dengue_df_biannual_no_pm),]

#hist((log(incidence_data_yearly$incidence)*-1))
#summary(test)
#hist(unique(incidence_data_yearly$population))
#summary(unique(incidence_data_yearly$population))
#plot(predict(test, incidence_data_yearly)[!is.na(predict(test, incidence_data_yearly))], residuals(test))
#plot(predict(test_popweight, incidence_data_yearly), residuals(test_popweight))

###################
### leish data ####
###################
### yearly data
leish_df_biannual <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/processed_case_data/biannual_leish_incidence_data_pop_adjusted.csv")
leish_df_biannual$incidence <- (leish_df_biannual$biannual_cases+1)/leish_df_biannual$population #add one so 0's dont go to infinity when logged
leish_df_biannual$year <- as.factor(leish_df_biannual$biannual_date)

### add covariates
covariates <- read.csv("~/Desktop/doctorate/ch2 mdd highway/data/covariates_data/mdd_biannual_covariates.csv")
leish_df_biannual <- full_join(leish_df_biannual, covariates, by=c("cluster"="cluster", "biannual_date" = "biannual_date"))

#urban area (to be able to take the log later)
leish_df_biannual$urban_area <- leish_df_biannual$urban_area + 0.0001

#remove 16 and 66 (pop zero)
leish_df_biannual <- leish_df_biannual[which(leish_df_biannual$cluster %in% c(1:15, 17:65, 67:70)),]

#complete cases
leish_df_biannual <- leish_df_biannual[complete.cases(leish_df_biannual),]

# remove extreme outliers
leish_df_biannual <- leish_df_biannual[which(leish_df_biannual$incidence < 0.5),]

#check how many are always zero
leish_df_biannual_zeroes <- leish_df_biannual  %>% 
  group_by(cluster) %>% 
  summarize(total_cases = sum(biannual_cases))
leish_clusters_w_at_least_one_case_biannual <- leish_df_biannual$cluster[which(leish_df_biannual_zeroes$total_cases>0)]
leish_df_biannual_at_least_one_case <- leish_df_biannual[which(leish_df_biannual$cluster %in% leish_clusters_w_at_least_one_case_biannual),]

#remove PM
leish_df_biannual_no_pm <- leish_df_biannual[!(leish_df_biannual$cluster %in% 1),]
leish_df_biannual_no_pm <- leish_df_biannual[complete.cases(leish_df_biannual_no_pm),]

```

```{r, raw biannual dengue data plots}
dengue_df_biannual$biannual_date <- as.Date(dengue_df_biannual$biannual_date)
dengue_df_biannual$onekm <- as.character(dengue_df_biannual$onekm)
dengue_df_biannual$fivekm <- as.character(dengue_df_biannual$fivekm)
dengue_df_biannual$tenkm <- as.character(dengue_df_biannual$tenkm)

#plots
#onekm
onekm_plotting <- dengue_df_biannual %>%
  group_by(onekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

onekm_biannual <- ggplot(onekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
onekm_biannual

#fivekm
fivekm_plotting <- dengue_df_biannual %>%
  group_by(fivekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

fivekm_biannual <- ggplot(fivekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#fivekm_biannual

#tenkm
tenkm_plotting <- dengue_df_biannual %>%
  group_by(tenkm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

tenkm_biannual <- ggplot(tenkm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_biannual

``` 

All the same as the description for the yearly model above, except for unit and biannual fixed effects and standard errors are clustered at the unit and biannual levels. I also colored the coefficients by rainy (red) or dry (white) season. The rainy season is regarded as the main dengue season in this region and runs from the beginning of October to the end of March. 

UPDATE (Jan 22nd): These results now include controls for biannual mean precipitation, biannual mean temperature, and biannual urban area, with no noticeable impact (as expected).

```{r, biannual dengue model}
dengue_df_biannual$onekm <- as.numeric(dengue_df_biannual$onekm)
dengue_df_biannual$fivekm <- as.numeric(dengue_df_biannual$fivekm)
dengue_df_biannual$tenkm <- as.numeric(dengue_df_biannual$tenkm)
### biannual model
dengue_biannual_model <- fepois(incidence ~ i(biannual_date, onekm, ref = '2008-04-01') + mean_precip + mean_temp + urban_area | cluster + biannual_date, vcov = "twoway", data = dengue_df_biannual, weights=~population)
#summary(dengue_biannual_model)

df <- as.data.frame(dengue_biannual_model$coeftable)
df <- df[1:41,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$biannual_date <- as.Date(c(unique(dengue_df_biannual$biannual_date)[c(1:16,18:42)]))
df$rainy <- 0
df$rainy[c(seq(1, 42, 2))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
dengue_biannual_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=biannual_date, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-04-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-04-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(biannual_date, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', '#DC267F'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("log(biannual\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_biannual_did_popadj
ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure3.pdf", dengue_biannual_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")
```

# Leish results

## Yearly leish incidence

Raw data showing yearly leishmaniasis incidence in treatment (<1km) and control (>1km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

```{r, raw yearly data plots}
vert_line_date <- as.Date('2008-01-01')

#plots
#onekm
onekm_plotting <- leish_df_yearly %>%
  group_by(onekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

onekm_plotting$year <- as.Date(onekm_plotting$year)
onekm_plotting$onekm <- as.character(onekm_plotting$onekm)

onekm_yearly_leish <- ggplot(onekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
onekm_yearly_leish

#fivekm
fivekm_plotting <- leish_df_yearly %>%
  group_by(fivekm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

fivekm_yearly_leish <- ggplot(fivekm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#fivekm_yearly_leish

#tenkm
tenkm_plotting <- leish_df_yearly %>%
  group_by(tenkm, year) %>%
  summarize(new_incidence = sum(yearly_cases)/sum(population))

tenkm_yearly_leish <- ggplot(tenkm_plotting) +
  geom_line(aes(x=year, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Yearly\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_yearly_leish

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S2_leish.pdf", onekm_yearly_leish, width = 10, height = 6, units = c("in"), device="pdf")

``` 

## Diff-in-diff results (yearly leish model)

All the same as the description for the yearly dengue model above, except that now we would expect the coefficients to center on zero both before and after the paving. This would align with our hypothesis that leishmaniasis transmission was not impacted by the road paving. The coefficients are as expected. Please see the end of this document for easy side-by-side comparisons of the two disease systems. 

UPDATE (Jan 22nd): These results now include controls for yearly mean precipitation, yearly mean temperature, and yearly urban area, with no noticeable impact (as expected).

```{r, main leish specification}
### yearly leish model
leish_yearly_model <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + mean_precip + mean_temp + urban_area | cluster + year, vcov = "twoway", data = leish_df_yearly, weights=~population)
#summary(leish_yearly_model)

df <- as.data.frame(leish_yearly_model$coeftable)
df <- df[1:20,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_yearly_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate), size=3, shape=21, fill='white') +
  xlab("Year") + ylab("log(yearly\nleish incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_yearly_did_popadj

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure2leish.pdf", leish_yearly_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")

```

## Biannual leish model

Raw data showing quarterly leishmaniasis incidence in treatment (<1km) and control (>1km) groups. Vertical line is at 2008 (last year before hypothesized "shock", i.e. the completed paving). 

UPDATE (Jan 22nd): These results now include controls for biannual mean precipitation, biannual mean temperature, and biannual urban area, with no noticeable impact (as expected).

```{r, raw biannual leish data plots}
#plots
#onekm
onekm_plotting <- leish_df_biannual %>%
  group_by(onekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

onekm_plotting$biannual_date <- as.Date(onekm_plotting$biannual_date)
onekm_plotting$onekm <- as.character(onekm_plotting$onekm)

onekm_biannual_leish <- ggplot(onekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=onekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>1km)', 'Near (<1km)'),) +
  theme_bw()+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
onekm_biannual_leish

#fivekm
fivekm_plotting <- leish_df_biannual %>%
  group_by(fivekm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

fivekm_biannaul_leish <- ggplot(fivekm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=fivekm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>5km)', 'Near (<5km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#fivekm_biannaul_leish

#tenkm
tenkm_plotting <- leish_df_biannual %>%
  group_by(tenkm, biannual_date) %>%
  summarize(new_incidence = sum(biannual_cases)/sum(population))

tenkm_biannual_leish <- ggplot(tenkm_plotting) +
  geom_line(aes(x=biannual_date, y=new_incidence, colour=tenkm)) +
  geom_vline(xintercept=vert_line_date,linetype='dashed') +
  #labs(color="Model Type") +
  #ggtitle("B. straminea") +
  xlab("Year") + ylab("Biannual\nincidence") + 
  scale_color_manual(name = "Treatment", values=c('#3ecbdd', '#FFBC42'), labels=c('Far (>10km)', 'Near (<10km)'),) +
  theme_bw()+
  theme(plot.title = element_text(hjust=0.5, size=26, face="italic"),
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=22),
        axis.title.y=element_text(size=16,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=16),
        axis.title.x=element_text(size=16),
        axis.text.x=element_text(size=16),
        axis.text = element_text(size=16),
        legend.text=element_text(size=14),
        legend.title=element_text(size=14),
        legend.position = "right",
        strip.text.x = element_text(size = 14))
#tenkm_biannual_leish
``` 

All the same as the description for the quarterly dengue model above, except that we expect coefficients to remain at zero as we did for the yearly leish regression model. Season coloring is the same as the biannual dengue model above.

```{r, biannual leish model}
### biannual model
leish_biannual_model <- fepois(incidence ~ i(biannual_date, onekm, ref = '2008-04-01') + mean_precip + mean_temp + urban_area | cluster + biannual_date, vcov = "twoway", data = leish_df_biannual, weights=~population)
#summary(leish_biannual_model)

df <- as.data.frame(leish_biannual_model$coeftable)
df <- df[1:41,]
colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value')
df$biannual_date <- as.Date(c(unique(leish_df_biannual$biannual_date)[c(1:16,18:42)]))
df$rainy <- 0
df$rainy[c(seq(1, 42, 2))] <- 1
df$rainy <- as.character(df$rainy)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
leish_biannual_did_popadj <- ggplot(df) +
  geom_hline(aes(yintercept=0), colour='red', size=.4) +
  geom_errorbar(aes(x=biannual_date, ymax=upper, ymin=lower), width=0, size=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-04-01")), linetype='dashed', size=0.4) +
  geom_point(aes(x=as.Date("2008-04-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(biannual_date, estimate, fill=rainy), size=3, shape=21) +
  scale_fill_manual(name="Season", values=c('white', '#DC267F'), labels=c('Dry', 'Rainy')) + 
  xlab("Year") + ylab("log(biannual\nleish incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_biannual_did_popadj
ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure3leish.pdf", leish_biannual_did_popadj, width = 10, height = 6, units = c("in"), device="pdf")
```


```{r, side by side plots, eval=F}
dengue_yearly_did_popadj + ggtitle("Dengue yearly")
leish_yearly_did_popadj + ggtitle("Leish yearly")

dengue_biannual_did_popadj + ggtitle("Dengue biannually")
leish_biannual_did_popadj + ggtitle("Leish biannually")
```

# Sensitivity Analyses

## Urban cover covariate sensitivity analysis

```{r, urban cover sensitivity}
dengue_yearly_model_linear_urban <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_log_urban <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + log(urban_area) + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_linear_urban$coeftable[1:19,],c(rep("Linear urban",19)))),
  as.data.frame(cbind(dengue_yearly_model_log_urban$coeftable[1:19,],c(rep("Log urban",19)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Urban covariate')
df$year <- c(seq(as.Date("2001-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Urban <- factor(as.character(df$Urban), levels=c('Linear urban','Log urban'))
dengue_yearly_did_urban_form <- ggplot(df, aes(group=Urban)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Urban), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Urban), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('Linear urban'="#DC267F",'Log urban'="#FFB000"))+
  scale_fill_manual(values=list('Linear urban'="#DC267F",'Log urban'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_urban_form

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S5.pdf", dengue_yearly_did_urban_form, width = 10, height = 6, units = c("in"), device="pdf")

```

## Spatial boundary sensitivity analysis
```{r, spatial bounday sensitivity}
# run multiple models with spatial boundary sensitivity
dengue_yearly_model_1km <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_5km <- fepois(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_10km <- fepois(incidence ~ i(year, tenkm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
#summary(test1km)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_1km$coeftable[1:20,],c(rep("1km",20)))),
  as.data.frame(cbind(dengue_yearly_model_5km$coeftable[1:20,],c(rep("5km",20)))),
  as.data.frame(cbind(dengue_yearly_model_10km$coeftable[1:20,],c(rep("10km",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Cutoff')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Cutoff <- factor(as.character(df$Cutoff), levels=c('1km','5km','10km'))
dengue_yearly_did_popadj_spatial_sens <- ggplot(df, aes(group=Cutoff)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Cutoff), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Cutoff), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('1km'="#DC267F",'5km'="#FFB000",'10km'='#648FFF'))+
  scale_fill_manual(values=list('1km'="#DC267F",'5km'="#FFB000",'10km'='#648FFF'))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_spatial_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure4.pdf", dengue_yearly_did_popadj_spatial_sens, width = 12, height = 6, units = c("in"), device="pdf")

```

```{r, spatial bounday sensitivity v2, eval=F}
## Spatial boundary sensitivity analysis v2
dengue_yearly_model_1km <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_5km <- fepois(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_10km <- fepois(incidence ~ i(year, tenkm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_20km <- fepois(incidence ~ i(year, twentykm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_30km <- fepois(incidence ~ i(year, thirtykm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_40km <- fepois(incidence ~ i(year, fortykm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
#summary(dengue_yearly_model_1km)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_1km$coeftable[1:20,],c(rep("1km",20)))),
  as.data.frame(cbind(dengue_yearly_model_5km$coeftable[1:20,],c(rep("5km",20)))),
  as.data.frame(cbind(dengue_yearly_model_10km$coeftable[1:20,],c(rep("10km",20)))),
  as.data.frame(cbind(dengue_yearly_model_20km$coeftable[1:20,],c(rep("20km",20)))),
  as.data.frame(cbind(dengue_yearly_model_30km$coeftable[1:20,],c(rep("30km",20)))),
  as.data.frame(cbind(dengue_yearly_model_40km$coeftable[1:20,],c(rep("40km",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Cutoff')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Cutoff <- factor(as.character(df$Cutoff), levels=c('1km','5km','10km','20km','30km','40km'))
dengue_yearly_did_popadj_spatial_sens_v2 <- ggplot(df, aes(group=Cutoff)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Cutoff), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Cutoff), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('1km'="#648FFF",'5km'="#785EF0",'10km'='#DC267F','20km'='#FE6100','30km'='#FFB000','40km'='#FFE518'))+
  scale_fill_manual(values=list('1km'="#648FFF",'5km'="#785EF0",'10km'='#DC267F','20km'='#FE6100','30km'='#FFB000','40km'='#FFE518'))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_spatial_sens_v2

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure4v2.pdf", dengue_yearly_did_popadj_spatial_sens_v2, width = 13, height = 6, units = c("in"), device="pdf")

```

## Population weighting sensitivity analysis
```{r, pop weight sensitivity}
dengue_yearly_model_unweighted <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly)
dengue_yearly_model_weighted <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_unweighted$coeftable[1:20,],c(rep("No weighting",20)))),
  as.data.frame(cbind(dengue_yearly_model_weighted$coeftable[1:20,],c(rep("Pop weighting",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Weighting')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Weighting <- factor(as.character(df$Weighting), levels=c('No weighting','Pop weighting'))
dengue_yearly_did_popweighting <- ggplot(df, aes(group=Weighting)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Weighting), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Weighting), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('No weighting'="#DC267F",'Pop weighting'="#FFB000"))+
  scale_fill_manual(values=list('No weighting'="#DC267F",'Pop weighting'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popweighting

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S4.pdf", dengue_yearly_did_popweighting, width = 10, height = 6, units = c("in"), device="pdf")


leish_yearly_model_unweighted <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = leish_df_yearly)
leish_yearly_model_weighted <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = leish_df_yearly, weights=~population)

df <- rbind(
  as.data.frame(cbind(leish_yearly_model_unweighted$coeftable[1:20,],c(rep("No weighting",20)))),
  as.data.frame(cbind(leish_yearly_model_weighted$coeftable[1:20,],c(rep("Pop weighting",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Weighting')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Weighting <- factor(as.character(df$Weighting), levels=c('No weighting','Pop weighting'))
leish_yearly_did_popweighting <- ggplot(df, aes(group=Weighting)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Weighting), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Weighting), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('No weighting'="#DC267F",'Pop weighting'="#FFB000"))+
  scale_fill_manual(values=list('No weighting'="#DC267F",'Pop weighting'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\nleish incidence\nrate ratio)") + 
  theme_bw()+
  ylim(c(-2.5,6))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
leish_yearly_did_popweighting

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/S4_leish.pdf", leish_yearly_did_popweighting, width = 10, height = 6, units = c("in"), device="pdf")

```

## Puerto Maldonado sensitivity analysis (1km and 5km)

#### 1km boundary

```{r, pm sensitivity 1km}
dengue_yearly_model_wpm <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_wopm <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_no_pm, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_wpm$coeftable[1:20,],c(rep("Yes PM",20)))),
  as.data.frame(cbind(dengue_yearly_model_wopm$coeftable[1:20,],c(rep("No PM",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Inclusion')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Inclusion <- factor(as.character(df$Inclusion), levels=c('Yes PM','No PM'))
dengue_yearly_did_popadj_pm_sens <- ggplot(df, aes(group=Inclusion)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Inclusion), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Inclusion), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  scale_fill_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_pm_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure5_1km.pdf", dengue_yearly_did_popadj_pm_sens, width = 10, height = 6, units = c("in"), device="pdf")

```

#### 5km boundary

```{r, pm sensitivity 5km}
dengue_yearly_model_wpm <- fepois(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_wopm <- fepois(incidence ~ i(year, fivekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_no_pm, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_wpm$coeftable[1:20,],c(rep("Yes PM",20)))),
  as.data.frame(cbind(dengue_yearly_model_wopm$coeftable[1:20,],c(rep("No PM",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Inclusion')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Inclusion <- factor(as.character(df$Inclusion), levels=c('Yes PM','No PM'))
dengue_yearly_did_popadj_pm_sens <- ggplot(df, aes(group=Inclusion)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Inclusion), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Inclusion), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  scale_fill_manual(values=list('Yes PM'="#DC267F",'No PM'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_pm_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure5_5km.pdf", dengue_yearly_did_popadj_pm_sens, width = 10, height = 6, units = c("in"), device="pdf")

```

## Base year sensitivity analysis
```{r, base year sensitivity}
dengue_yearly_model_2008 <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_2007 <- fepois(incidence ~ i(year, onekm, ref = '2007-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_2006 <- fepois(incidence ~ i(year, onekm, ref = '2006-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
#summary(test)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_2008$coeftable[1:20,],c(rep("2008",20)))),
  as.data.frame(cbind(dengue_yearly_model_2007$coeftable[1:20,],c(rep("2007",20)))),
  as.data.frame(cbind(dengue_yearly_model_2006$coeftable[1:20,],c(rep("2006",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Year')
df$year_date <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
                  seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"),
                  seq(as.Date("2000-01-01"), as.Date("2006-01-01"), by="year"),
                  seq(as.Date("2008-01-01"), as.Date("2020-01-01"), by="year"),
                  seq(as.Date("2000-01-01"), as.Date("2005-01-01"), by="year"),
                  seq(as.Date("2007-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Year <- factor(as.character(df$Year), levels=c('2006','2007','2008'))
dengue_yearly_did_popadj_base_year_sens <- ggplot(df, aes(group=Year)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year_date, ymax=upper, ymin=lower, color=Year), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2006-01-01")), linetype='dashed', linewidth=0.4, color='#DC267F') +
  geom_vline(aes(xintercept=as.Date("2007-01-01")), linetype='dashed', linewidth=0.4, color='#FFB000') +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4, color='#648FFF') +
  geom_point(aes(x=as.Date("2006-01-01"), y=0), size=3, shape=21, fill='#DC267F') +
  geom_point(aes(x=as.Date("2007-01-01"), y=0), size=3, shape=21, fill='#FFB000') +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='#648FFF') +
  geom_point(aes(year_date, estimate, fill=Year), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(name="Baseline Year",values=list('2006'="#DC267F",'2007'="#FFB000",'2008'='#648FFF'))+
  scale_fill_manual(name="Baseline Year", values=list('2006'="#DC267F",'2007'="#FFB000",'2008'='#648FFF'))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_base_year_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure6.pdf", dengue_yearly_did_popadj_base_year_sens, width = 12, height = 6, units = c("in"), device="pdf")

```

```{r, base year w 2009 sensitivity, eval=F}
dengue_yearly_model_2009 <- fepois(incidence ~ i(year, onekm, ref = '2009-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_2008 <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_2007 <- fepois(incidence ~ i(year, onekm, ref = '2007-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_2006 <- fepois(incidence ~ i(year, onekm, ref = '2006-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_2009$coeftable[1:20,],c(rep("2009",20)))),
  as.data.frame(cbind(dengue_yearly_model_2008$coeftable[1:20,],c(rep("2008",20)))),
  as.data.frame(cbind(dengue_yearly_model_2007$coeftable[1:20,],c(rep("2007",20)))),
  as.data.frame(cbind(dengue_yearly_model_2006$coeftable[1:20,],c(rep("2006",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Year')
df$year_date <- c(seq(as.Date("2000-01-01"), as.Date("2008-01-01"), by="year"),
                  seq(as.Date("2010-01-01"), as.Date("2020-01-01"), by="year"),
                  seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
                  seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"),
                  seq(as.Date("2000-01-01"), as.Date("2006-01-01"), by="year"),
                  seq(as.Date("2008-01-01"), as.Date("2020-01-01"), by="year"),
                  seq(as.Date("2000-01-01"), as.Date("2005-01-01"), by="year"),
                  seq(as.Date("2007-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Year <- factor(as.character(df$Year), levels=c('2006','2007','2008', '2009'))
dengue_yearly_did_popadj_base_year_2009_sens <- ggplot(df, aes(group=Year)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year_date, ymax=upper, ymin=lower, color=Year), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2006-01-01")), linetype='dashed', linewidth=0.4, color='#DC267F') +
  geom_vline(aes(xintercept=as.Date("2007-01-01")), linetype='dashed', linewidth=0.4, color='#FFB000') +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4, color='#648FFF') +
  geom_vline(aes(xintercept=as.Date("2009-01-01")), linetype='dashed', linewidth=0.4, color='#785EF0') +
  geom_point(aes(x=as.Date("2006-01-01"), y=0), size=3, shape=21, fill='#DC267F') +
  geom_point(aes(x=as.Date("2007-01-01"), y=0), size=3, shape=21, fill='#FFB000') +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='#648FFF') +
  geom_point(aes(x=as.Date("2009-01-01"), y=0), size=3, shape=21, fill='#785EF0') +
  geom_point(aes(year_date, estimate, fill=Year), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(name="Baseline Year",values=list('2006'="#DC267F",'2007'="#FFB000",'2008'='#648FFF', '2009'="#785EF0"))+
  scale_fill_manual(name="Baseline Year", values=list('2006'="#DC267F",'2007'="#FFB000",'2008'='#648FFF', '2009'="#785EF0"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_base_year_2009_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure6v2.pdf", dengue_yearly_did_popadj_base_year_2009_sens, width = 12, height = 6, units = c("in"), device="pdf")

```

## Permute treatment dummy
```{r, permute treatment test}
#permute treatment dummy
set.seed(98)
dengue_df_yearly_permuted  <- transform(dengue_df_yearly, onekm = sample(onekm))   
#repeat for 1000 draws
#for(i in 1:100){
#}

#build models
dengue_yearly_model_baseline <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_permuted <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_permuted, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_baseline$coeftable[1:20,],c(rep("Baseline",20)))),
  as.data.frame(cbind(dengue_yearly_model_permuted$coeftable[1:20,],c(rep("Permuted",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Order')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Order <- factor(as.character(df$Order), levels=c('Baseline','Permuted'))
dengue_yearly_did_popadj_permutation_test <- ggplot(df, aes(group=Order)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Order), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Order), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(values=list('Baseline'="#DC267F",'Permuted'="#FFB000"))+
  scale_fill_manual(values=list('Baseline'="#DC267F",'Permuted'="#FFB000"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.2))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_permutation_test

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure7.pdf", dengue_yearly_did_popadj_permutation_test, width = 10, height = 6, units = c("in"), device="pdf")

```

## Buffer zone sensitivity analysis
```{r, buffer zone sensitivity}
# build treatment dummy where below 1km is 1, between 1km and 10km are thrown out, and above 10km is 0
dengue_df_yearly_buffered <- dengue_df_yearly
dengue_df_yearly_buffered$fivekm <- ifelse(dengue_df_yearly_buffered$fivekm>0, 2, 0)
dengue_df_yearly_buffered$tenkm <- ifelse(dengue_df_yearly_buffered$tenkm>0, 3, 0)
dengue_df_yearly_buffered$twentykm <- ifelse(dengue_df_yearly_buffered$twentykm>0, 4, 0)
dengue_df_yearly_buffered$thirtykm <- ifelse(dengue_df_yearly_buffered$thirtykm>0, 5, 0)
dengue_df_yearly_buffered$fortykm <- ifelse(dengue_df_yearly_buffered$fortykm>0, 6, 0)
for(i in 1:dim(dengue_df_yearly_buffered)[1]){
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$onekm[i]>0, 1, 0)
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$fivekm[i]>1&&dengue_df_yearly_buffered$onekm[i]==0, 2, dengue_df_yearly_buffered$all_cutoffs[i])
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$tenkm[i]>2&&dengue_df_yearly_buffered$fivekm[i]==0&&
                                                            dengue_df_yearly_buffered$onekm[i]==0, 3, dengue_df_yearly_buffered$all_cutoffs[i])
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$twentykm[i]>3&&dengue_df_yearly_buffered$tenkm[i]==0&&
                                                            dengue_df_yearly_buffered$fivekm[i]==0&&dengue_df_yearly_buffered$onekm[i]==0, 4, 
                                                          dengue_df_yearly_buffered$all_cutoffs[i])
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$thirtykm[i]>4&&dengue_df_yearly_buffered$twentykm[i]==0&&
                                                            dengue_df_yearly_buffered$tenkm[i]==0&&dengue_df_yearly_buffered$fivekm[i]==0&&
                                                            dengue_df_yearly_buffered$onekm[i]==0, 5, dengue_df_yearly_buffered$all_cutoffs[i])
  dengue_df_yearly_buffered$all_cutoffs[i] <- ifelse(dengue_df_yearly_buffered$fortykm[i]>5&&dengue_df_yearly_buffered$thirtykm[i]==0&&dengue_df_yearly_buffered$twentykm[i]==0&&
                                                            dengue_df_yearly_buffered$tenkm[i]==0&&dengue_df_yearly_buffered$fivekm[i]==0&&
                                                            dengue_df_yearly_buffered$onekm[i]==0, 6, dengue_df_yearly_buffered$all_cutoffs[i])
}
dengue_df_yearly_buffered_13 <- dengue_df_yearly_buffered[which(dengue_df_yearly_buffered$all_cutoffs %in% c(1,3,4,5,6,0)),]
dengue_df_yearly_buffered_14 <- dengue_df_yearly_buffered[which(dengue_df_yearly_buffered$all_cutoffs %in% c(1,4,5,6,0)),]
dengue_df_yearly_buffered_15 <- dengue_df_yearly_buffered[which(dengue_df_yearly_buffered$all_cutoffs %in% c(1,5,6,0)),]
dengue_df_yearly_buffered_16 <- dengue_df_yearly_buffered[which(dengue_df_yearly_buffered$all_cutoffs %in% c(1,6,0)),]
dengue_df_yearly_buffered_10 <- dengue_df_yearly_buffered[which(dengue_df_yearly_buffered$all_cutoffs %in% c(1,0)),]


# run models
dengue_yearly_model_1km <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly, weights=~population)
dengue_yearly_model_1_5_buffer <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_buffered_13, weights=~population)
dengue_yearly_model_1_10_buffer <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_buffered_14, weights=~population)
dengue_yearly_model_1_20_buffer <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_buffered_15, weights=~population)
dengue_yearly_model_1_30_buffer <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_buffered_16, weights=~population)
dengue_yearly_model_1_40_buffer <- fepois(incidence ~ i(year, onekm, ref = '2008-01-01') + urban_area + mean_precip + mean_temp | cluster + year, vcov = "twoway", data = dengue_df_yearly_buffered_10, weights=~population)

df <- rbind(
  as.data.frame(cbind(dengue_yearly_model_1km$coeftable[1:20,],c(rep("1km",20)))),
  #as.data.frame(cbind(test1_10_buffer$coeftable[1:20,],c(rep("10km_buffered",20)))),
  as.data.frame(cbind(dengue_yearly_model_1_20_buffer$coeftable[1:20,],c(rep("20km_buffered",20)))),
  as.data.frame(cbind(dengue_yearly_model_1_40_buffer$coeftable[1:20,],c(rep("40km_buffered",20)))))

colnames(df) <- c('estimate', 'std_error', 't_value', 'p_value', 'Cutoff')
df$year <- c(seq(as.Date("2000-01-01"), as.Date("2007-01-01"), by="year"),
             seq(as.Date("2009-01-01"), as.Date("2020-01-01"), by="year"))
df$estimate <- as.numeric(df$estimate)
df$std_error <- as.numeric(df$std_error)
df$upper <- df$estimate+1.96*df$std_error
df$lower <- df$estimate-1.96*df$std_error
df$Cutoff <- factor(as.character(df$Cutoff), levels=c('1km','20km_buffered','40km_buffered'))
dengue_yearly_did_popadj_buffer_sens <- ggplot(df, aes(group=Cutoff)) +
  geom_hline(aes(yintercept=0), colour='red', linewidth=.4) +
  geom_errorbar(aes(x=year, ymax=upper, ymin=lower, color=Cutoff), position = position_dodge(width=250), width=0.1, linewidth=0.5) +
  geom_vline(aes(xintercept=as.Date("2008-01-01")), linetype='dashed', linewidth=0.4) +
  geom_point(aes(x=as.Date("2008-01-01"), y=0), size=3, shape=21, fill='white') +
  geom_point(aes(year, estimate, fill=Cutoff), color='black',position = position_dodge(width=250), size=3, shape=21) +
  scale_color_manual(name="Treament, control", values=list('1km'="#648FFF",'20km_buffered'='#DC267F',
                                                   '40km_buffered'='#FFB000'),#'40km_buffered'='#FFE518'), 
                     labels=list("1km"="<1km, >1km",
                                 "20km_buffered"="<1km, >20km", "40km_buffered"="<1km, >40km"))+
  scale_fill_manual(name="Treament, control", values=list('1km'="#648FFF",'20km_buffered'='#DC267F',
                                                  '40km_buffered'='#FFB000'),#'40km_buffered'='#FFE518'), 
                    labels=list("1km"="<1km, >1km",
                                 "20km_buffered"="<1km, >20km", "40km_buffered"="<1km, >40km"))+
  xlab("Year") + ylab("log(yearly\ndengue incidence\nrate ratio)") + 
  theme_bw()+
  #ylim(c(-0.02,0.22))+
  theme(plot.title = element_text(size=20),
        plot.title.position = "plot",
        plot.subtitle = element_text(hjust=0.5, size=22),
        axis.title=element_text(size=18),
        axis.title.y=element_text(size=14,angle=0, vjust=.5, hjust=0.5),
        axis.text.y=element_text(size=12),
        axis.title.x=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text = element_text(size=14),
        legend.text=element_text(size=12),
        legend.title=element_text(size=12),
        legend.position = "right",
        strip.text.x = element_text(size = 12))
dengue_yearly_did_popadj_buffer_sens

ggsave("~/Desktop/doctorate/ch2 mdd highway/presentation_figures/Figure8.pdf", dengue_yearly_did_popadj_buffer_sens, width = 12, height = 6, units = c("in"), device="pdf")

```
