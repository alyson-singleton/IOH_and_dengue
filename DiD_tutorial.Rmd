---
title: "Difference-in-differences (DiD)"
author: "Alyson (Aly) Singleton"
date: "Agosto 2025"
output:
  html_document: default
  word_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

## notes
1. make seperate repo for this tutorial
2. create simplified data (colnames in spanish, reduce columns)

## Libraries

Install and load necessary libraries. We will use the _fixest_ package in R throughout this tutorial, which is a very common package for working with panel data.

```{r}
library(ggplot2)
library(dplyr)
library(fixest)
# you can find nice fixest documentation help here:
#     
```

## Load data

First, load in the two necessary datasets (one for dengue and one for leish). These are the cleaned datasets with all pre-processing done. You can reference the full repository for data processing steps. This example workflow will use the dengue data, but you can switch out for leish data if you want.

```{r}
dengue_yearly <- readRDS("data/clean/dengue_yearly_panels.rds")
dengue_yearly <- dengue_yearly$connected_buffered
dengue_yearly$year_chr <- substr(as.character(dengue_yearly$year),1,4)
leish_yearly <- readRDS("data/clean/leish_yearly_panels.rds")
leish_yearly <- leish_yearly$connected_buffered
```

## Explore data

Let's check out the structure of the data. You can see the data is in long format, where we have a time column (year) and a unit column (e_salud).  

```{r}
# look at column names and data structure
colnames(dengue_yearly)
head(dengue_yearly)
View(dengue_yearly)

# this shows we have 81 units for each time period
table(dengue_yearly$year)
# this shows we have 23 years for each health facility
table(dengue_yearly$key)

# "treatment" column

```

Take a second to explore the dengue data by plotting incidence over time. First, create a plot showing dengue incidence for each health facility over time, colored by exposure group. Next, aggregate the groups and plot mean incidence over time for each exposure group.

```{r}
# plot incidence for each health facility across study period, color by treatment (<5km) and control (>10km)

# we want treatment to be a character vector for plotting (but numeric for running the models)
dengue_yearly_plotting <- dengue_yearly
dengue_yearly_plotting$fivekm <- as.character(dengue_yearly_plotting$fivekm) 

# incidence plot for each health facility
ggplot(dengue_yearly_plotting) +
  geom_line(aes(year_chr, incidence, group=key, color=fivekm), alpha=0.7) +
  scale_color_manual(values = c('darkblue', 'pink2'), 
                     labels = c("Control", "Exposed"), 
                     name="Group") +
  geom_vline(xintercept='2008',linetype='dashed') +
  xlab("Year") + ylab("Dengue\nincidence\n per 1k") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(angle = 0, vjust = 0.5))
```

```{r}
# aggregate by treatment and control group and plot mean incidence rates across the study period
dengue_yearly_plotting_agg <- dengue_yearly %>%
  group_by(fivekm, year_chr) %>%
  summarize(mean_incidence = mean(incidence))
dengue_yearly_plotting_agg$fivekm <- as.character(dengue_yearly_plotting_agg$fivekm)

# incidence plot for aggregated treatment groups
ggplot(dengue_yearly_plotting_agg) +
  geom_line(aes(year_chr, mean_incidence, group = fivekm, color=fivekm)) +
  scale_color_manual(values = c('darkblue', 'pink2'),
                     labels = c("Control", "Exposed"), 
                     name="Group") +
  geom_vline(xintercept='2008',linetype='dashed') +
  xlab("Year") + ylab("Dengue\nincidence\n per 1k") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(angle = 0, vjust = 0.5))
```

## Build simple model

Let's start with the simplest DiD model possible: only including the interaction term that compares the treatment and control group within each year to their difference in our reference year, 2008. There are currently no fixed effects and no control variables.

```{r}
# run model
dengue_yearly_model_simple <- feols(
  incidence ~ i(year_chr, fivekm, ref = '2008'), # tx/year interaction
  data = dengue_yearly)

# look at output
summary(dengue_yearly_model_simple)
fixest::etable(dengue_yearly_model_simple)
fixest::iplot(dengue_yearly_model_simple, xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Add fixed effects

Now let's add unit and year fixed effects to our model. As a reminder, unit fixed effects control for time-invariant, facility-level characteristics (baseline dengue burden, suitability for vectors, etc.). The year fixed effects control for common annual changes that impact all health facilities (particularly rainy year, change in national/region politics, etc.). What changes do you notice?

```{r}
# run model
dengue_yearly_model_FEs <- feols(
  incidence ~ i(year_chr, fivekm, ref = '2008') | # tx/year interaction
    key + year_chr, # fixed effects
  data = dengue_yearly)

# look at output
summary(dengue_yearly_model_FEs)
etable(dengue_yearly_model_FEs)
iplot(dengue_yearly_model_FEs, xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Full model (FEs + controls)

Finally, let's add in control variables. Here, we include urban area, agricultural area, precipitation, temperature, and temperature^2. Do you notice any changes?

```{r}
# run model
dengue_yearly_model_full <- feols(
  incidence ~ i(year_chr, fivekm, ref = '2008') + # tx/year interaction
    urban + ag + sum_precip_centered + #controls
    mean_temp_centered + mean_temp_centered_sq | 
    key + year_chr, # fixed effects
  data = dengue_yearly)

# look at output
summary(dengue_yearly_model_full)
etable(dengue_yearly_model_full)
iplot(dengue_yearly_model_full, xlab= "Year", ylab = "Effect (relative to 2008)")
```

## Long difference model

Extra extension: Here is the code for estimating the overall treatment effect across the whole time period, instead of one effect estimate for every year. This is called a long difference model.

The main change is how we construct the time column. Now, we create a new "time" column so that the year 2008 is 0 (our reference year) and all other year after 2008 are 1. We remove the years before 2008 because we want our control to only be 2008 (not 2000-2008). This compares the entire group of years post paving to our reference year, rather than comparing each to the reference year one at a time. 

```{r}
# create new treatment variable for long difference model
dengue_df_agg <- dengue_yearly %>%
  filter(as.Date(year) > as.Date("2007-01-01")) %>%
  mutate(year_binary = if_else(as.Date(year) > as.Date("2008-01-01"), 1, 0))

# run model
dengue_long_difference_model <- feols(
  incidence ~ year_binary * fivekm + # tx/period interaction
    urban + ag + sum_precip_centered + #controls
    mean_temp_centered + mean_temp_centered_sq | 
    key + year_binary, # fixed effects
  data = dengue_df_agg)

# look at output
summary(dengue_long_difference_model)
etable(dengue_long_difference_model)

# our average treatment effect across the time period
coef(dengue_long_difference_model)[6] 
```

If you have extra time, you can try running the models for leishmaniasis as well! Alternatively, you can look through the full GitHub here and try out some of the other models, such as biannual or the distance heterogeneity analyses.
